{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="section-title mb-0"><i class="bi bi-person-check"></i> Presença - {{ evento['nome'] }} / {{ momento['nome'] }}</h2>
  <a href="{{ url_for('ver_evento', evento_id=evento['id']) }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Voltar para Detalhes do Evento</a>
</div>
<div class="row g-4">
  <div class="col-md-7">
    <div class="card-panel">
      <form method="post" class="mb-3">
        <div class="row g-2 align-items-center">
          <div class="col">
            <select name="participante_id" class="form-select form-select-lg">
              {% for p in participantes %}
                <option value="{{ p['id'] }}">{{ p['nome'] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-person-check"></i> Marcar Presença</button>
          </div>
        </div>
      </form>
      <div class="mb-3">
        <h5 class="mb-2">Ou marque presença por reconhecimento facial:</h5>
        <video id="video" width="320" height="240" autoplay style="border:2px solid #00bfae; border-radius:10px;"></video>
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        <br>
        <button type="button" class="btn btn-primary btn-lg mt-2" id="btn-reconhecer"><i class="bi bi-search"></i> Reconhecer e Marcar Presença</button>
        <div id="preview" class="mt-2"></div>
        <div id="resultado" class="alert alert-info mt-4" style="display:none;"></div>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card-panel">
      <h4 class="mb-3"><i class="bi bi-list-check"></i> Presentes</h4>
      <ul class="list-group">
        {% for p in participantes %}
          {% if p['id'] in presentes %}
            <li class="list-group-item bg-success text-white fw-bold">{{ p['nome'] }}</li>
          {% endif %}
        {% else %}
          <li class="list-group-item bg-dark text-light">Nenhum presente ainda.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnReconhecer = document.getElementById('btn-reconhecer');
const resultado = document.getElementById('resultado');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
    video.srcObject = stream;
    video.play();
  });
}

btnReconhecer.onclick = function() {
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg');
  resultado.style.display = 'none';
  fetch(window.location.pathname + '/reconhecer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'img_data_url=' + encodeURIComponent(dataUrl)
  })
  .then(response => response.json())
  .then(data => {
    resultado.style.display = 'block';
    resultado.textContent = data.msg;
    if(data.success && data.msg && data.msg.includes('registrada')) {
      resultado.className = 'alert alert-success mt-4';
      setTimeout(() => window.location.reload(), 1500);
    } else if(data.success && data.msg && data.msg.includes('já está marcado')) {
      resultado.className = 'alert alert-warning mt-4';
    } else {
      resultado.className = 'alert alert-info mt-4';
    }
  });
}
</script>
{% endblock %}
